<!DOCTYPE html>
<html>
<head>
    <title>Shooting Game Screen</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P" rel="stylesheet">
    <link href="game_screen.css" rel="stylesheet">
</head>
<body>
    <div id = "game-container">
        <canvas width = "1050px" height="700px"></canvas>

        <svg xmlns="http://www.w3.org/2000/svg" id="counter">
            <text x="50%" y="60%">
                TIME:<tspan id="time-remaining">150</tspan>
            </text>
            <text x="13%" y = "60%">
                ACCURACY:<tspan id ="accuracy">0%</tspan>
            </text>
            <text x="87%" y = "50%">
                Your Score:<tspan id ="your-score">0</tspan>
            </text>
            <text x="87%" y = "90%">
                Enemy Score:<tspan id ="enemy-score">0</tspan>
            </text>
            <text ></text>
        </svg>



        <svg xmlns="http://www.w3.org/2000/svg" id="game-start">
            <defs>
                <linearGradient id="title-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset = "0%" stop-color="#D8B5FF"/>
                    <stop offset = "100%" stop-color="#1EAE98"/>
                </linearGradient>
            </defs>
            <text id = "match-found" x = "50%" y = "45%">Match Found!</text>
            <text id = "start-message" id x = "50%" y = "50%">
                Game will be starting in
                <tspan id = "count-down">3</tspan>
                !
            </text> 
        </svg>

        <svg xmlns="http://www.w3.org/2000/svg" id="game-over" display="none">
            <defs>
                <linearGradient id="game-over-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset = "0%" stop-color="#D8B5FF"/>
                    <stop offset = "100%" stop-color="#1EAE98"/>
                </linearGradient>
            </defs>
            <text x="50%" y="50%">
                Game End! Game
                <tspan id="win-lose">draws</tspan>
                !
            </text>
            <text x="50%" y = "60%">
                Redirecting in
                <tspan id="redirect-count">3</tspan>
                Seconds
            </text>
        </svg>
    </div>

    
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="bounding_box.js"></script>
    <script src="sprite.js"></script>
    <script src="gun.js"></script>
    <script src="game_object.js"></script>
    <script src="ability.js"></script>
    <script src="utility.js"></script>
    <script src="/socket.io/socket.io.min.js"></script>

    <script>

    $(function() {
        //Get the canvas and 2D content

        
        const cv = $("canvas").get(0);
        const context = cv.getContext("2d");

        const Canvas = {
            cv : cv,
            context : context
        };

        const gameStats = 
        {
            playerId: -1,       //The player id
            gameStartTime: 0,   //Starting time of the game
            currentTime: 0,     //Current time of the game
            totalShot: 0,       //Total shot fired
            hitShot: 0,         //Total shit hitted
            score: 0,           //Current score 
            enemyScore: 0,       //Score of opponent
            timeRemaining: 150  //Remaining time of the game
        };

        const totalGameTime = 150;

        //Create the game area
        const gameArea = BoundingBox(context, 0, 0, 700, 1050);
        
        const gameGun = {
           playerGun : Gun(context, 500, 350, gameArea),
           enemyGun : Gun(context, 500, 350, gameArea)
        };

        const objects = [GameObject(context, 0, 0, "gem"),
            GameObject(context, 0, 0, "gem"),
            GameObject(context, 0, 0, "gem")
        ];
        const abilitys = [Ability(context, 0, 0,"shootBoost")];
        objects[0].randomize(0);
        objects[1].randomize(1);
        objects[2].randomize(2);
        abilitys[0].randomize();

        const gameStartCountDown = function()
        {
            const num = $("#count-down").text();
            if(num == 0){
                $("#game-start").hide();
                requestAnimationFrame(doFrame);
            }
            else{
                $("#count-down").text(num - 1);
                setTimeout(gameStartCountDown());
            }
        };

        const checkFireHit = function(hitX, hitY, objectsList)
        {
            gameStats.totalShot +=1;
            let awardPoints = 0;
            let objectHitted = -1;
            for(let i = 0; i<objectsList.length; i++)
            {   
                if(objectsList[i].getBoundingBox().isPointInBox(hitX,hitY))
                {
                    awardPoints = objectsList[i].rewardPoints();
                    gameStats.hitShot += 1;
                    gameStats.score += awardPoints;
                    objectHitted = i;
                    $("#your-score").text(String(gameStats.score));
                    objectsList[i].randomize(i);
                    break;
                }
            }
            $("#accuracy").text(String(Math.round(gameStats.hitShot/gameStats.totalShot * 100)) + "%");
            return {awardPoints, objectHitted};
        };

        function doFrame(now){
            if (gameStats.gameStartTime == 0) gameStats.gameStartTime = now;
            

            gameStats.currentTime = now;


            //Update the time remaining for player 0 and player 1
            if(gameStats.playerId == 0){
                const gameTimeSoFar = now - gameStats.gameStartTime;
                gameStats.timeRemaining = Math.ceil((totalGameTime * 1000 - gameTimeSoFar) /1000);
                timeSynchronization(gameStats.timeRemaining);
            }

            $("#time-remaining").text(gameStats.timeRemaining);

            $("#your-score").text(String(gameStats.score));

            if(gameStats.timeRemaining <= 0)
            {
                
                $("#time-remaining").text(0);
                if(gameStats.score > gameStats.enemyScore)
                    $("#win-lose").text("win");
                else if(gameStats.score < gameStats.enemyScore)
                    $("#win-lost").text("lose");
                else
                    $("$win-lose").text("draw");
                $("#game-over").show();
                setTimeout(() => {location.href = "/Project/public/Game/game_over.html"}, 3000);
                return;
            }

            //Update the gun of the player
            gameGun.playerGun.update(now);

            //Send the player gun info to the server
            const {x, y} = (gameGun.playerGun.getXY());
            sendGraphicInfo(gameStats.playerId, x, y);

            //Update the gun of the other player
            gameGun.enemyGun.update(now);


            objects[0].update(now);
            objects[1].update(now);
            objects[2].update(now);
            abilitys[0].update(now);
            
            Utility.randomization(objects);
            Utility.randomization(abilitys);
            Utility.checkCollision(x,y, abilitys,gameGun.playerGun);
            Canvas.context.clearRect(0, 0, Canvas.cv.width, Canvas.cv.height);

            objects[0].draw();
            objects[1].draw();
            objects[2].draw();
            abilitys[0].draw();
            gameGun.playerGun.draw();
            gameGun.enemyGun.draw();
            requestAnimationFrame(doFrame);
        }

        $(document).on("keydown", function(event) {
            if(event.keyCode == "37"){
                gameGun.playerGun.move(1);
            }
            else if(event.keyCode == "38"){
                gameGun.playerGun.move(2);
            }
            else if(event.keyCode == "39"){
                gameGun.playerGun.move(3);
            }
            else if (event.keyCode == "40"){
                gameGun.playerGun.move(4);
            }
            else if (event.keyCode == "32"){
                const {x, y} = gameGun.playerGun.shoot(gameStats.currentTime);
                const {awardPoints, objectHitted} = checkFireHit(x, y, objects);
                fireEvent(gameStats.playerId, awardPoints, objectHitted);
            }
            else if (event.keyCode == "88"){
                gameStats.score += 50;
                gameStats.gameStartTime -= 50000;
            }
        });

        /* Handle the keyup of arrow keys and spacebar */
        $(document).on("keyup", function(event) {
            if(event.keyCode == "37"){
                gameGun.playerGun.stop(1);
            }
            else if(event.keyCode == "38"){
                gameGun.playerGun.stop(2);
            }
            else if(event.keyCode == "39"){
                gameGun.playerGun.stop(3);
            }
            else if (event.keyCode == "40"){
                gameGun.playerGun.stop(4);
            }
        });

        //This stores the current Socket.IO socket
        let socket = null;

        const connect = function(){
            //Connect to the servver
            socket = io();

            socket.on("connect", () => {
                console.log("connected sucessfully");
            });

            //Set up the matchFound event
            socket.on("MatchFound", (id) => {
                gameStats.playerId = id;
                console.log("called");
                gameStartCountDown();
            });

            //Set the the event when enemy hit a target
            socket.on("enemy hit", (awardPoints, objectHitted) => {
                console.log(awardPoints)
                gameStats.enemyScore += awardPoints;
                $("#enemy-score").text(String(gameStats.enemyScore));
            });

            //Update the enemy gun information
            socket.on("graphic update", (enemyGunX, enemyGunY) => {
                gameGun.enemyGun.setXY(enemyGunX, enemyGunY);
            });

            //Update the time information for player 1 to synchronize with player 0
            socket.on("time update", (timeRemaining) => {
                gameStats.timeRemaining = timeRemaining;
                $("#time-remaining").text(timeRemaining);
            })
        };

        const fireEvent = function(id, awardPoints, objectHitted){
            if(objectHitted != -1){
                socket.emit("fire event", id, awardPoints, objectHitted);
            }
        }

        const sendGraphicInfo = function(id, gun_x, gun_y){
            socket.emit("graphic info", id, gun_x, gun_y);
        }

        const timeSynchronization = function(timeRemaining){
            socket.emit("time synchronzation", timeRemaining);
        }
 

        connect();
    });

    
    </script>

    

</body>
</html>