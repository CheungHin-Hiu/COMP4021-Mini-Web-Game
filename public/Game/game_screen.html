<!DOCTYPE html>
<html>
<head>
    <title>Shooting Game Screen</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P" rel="stylesheet">
    <link href="game_screen.css" rel="stylesheet">
</head>
<body>
    <div id = "game-container">
        <canvas width = "1050px" height="700px"></canvas>

        <svg xmlns="http://www.w3.org/2000/svg" id="counter">
            <text x="50%" y="60%">
                TIME:<tspan id="time-remaining">150</tspan>
            </text>
            <text x="13%" y = "60%">
                ACCURACY:<tspan id ="accuracy">0%</tspan>
            </text>
            <text x="87%" y = "50%">
                Your Score:<tspan id ="your-score">0</tspan>
            </text>
            <text x="87%" y = "90%">
                Enemy Score:<tspan id ="your-score">0</tspan>
            </text>
            <text ></text>
        </svg>



        <svg xmlns="http://www.w3.org/2000/svg" id="game-start">
            <defs>
                <linearGradient id="title-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset = "0%" stop-color="#D8B5FF"/>
                    <stop offset = "100%" stop-color="#1EAE98"/>
                </linearGradient>
            </defs>
            <text id = "match-found" x = "50%" y = "45%">Match Found!</text>
            <text id = "start-message" id x = "50%" y = "50%">
                Game will be starting in
                <tspan id = "count-down">3</tspan>
                !
            </text> 
        </svg>

        <svg xmlns="http://www.w3.org/2000/svg" id="game-over" display="none">
            <defs>
                <linearGradient id="game-over-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset = "0%" stop-color="#D8B5FF"/>
                    <stop offset = "100%" stop-color="#1EAE98"/>
                </linearGradient>
            </defs>
            <text x="50%" y="50%">
                Game End! Game
                <tspan id="win-lose">draws</tspan>
                !
            </text>
            <text x="50%" y = "60%">
                Redirecting in
                <tspan id="redirect-count">3</tspan>
                Seconds
            </text>
        </svg>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="bounding_box.js"></script>
    <script src="sprite.js"></script>
    <script src="gun.js"></script>
    <script src="game_object.js"></script>
    <script src="ability.js"></script>
    <script src="utility.js"></script>
    <script>

    $(function() {
        //Get the canvas and 2D content
        const cv = $("canvas").get(0);
        const context = cv.getContext("2d");

        let gameStartTime = 0;

        let currentTime = 0;

        let totalShot = 0;

        let hitShot = 0;

        const totalGameTime = 150;

        let enemyScore = 0;
        let score = 0;

        //Create the game area
        const gameArea = BoundingBox(context, 0, 0, 700, 1050);
        const playerGun = Gun(context, 300, 350, gameArea);
        const objects = [GameObject(context, 0, 0, "gem"),
            GameObject(context, 0, 0, "gem"),
            GameObject(context, 0, 0, "gem")
        ] ;
        const abilitys = [Ability(context, 0, 0,"shootBoost")];
        objects[0].randomize(0);
        objects[1].randomize(1);
        objects[2].randomize(2);
        abilitys[0].randomize();

        function gameStartCountDown()
        {
            const num = $("#count-down").text();
            if(num == 0){
                $("#game-start").hide();
                requestAnimationFrame(doFrame);
            }
            else{
                $("#count-down").text(num - 1);
                setTimeout(gameStartCountDown, 1000);
            }
        }
        
        function checkFireHit(hitX, hitY, objectsList)
        {
            totalShot +=1;
            for(let i = 0; i<objectsList.length; i++)
            {   
                if(objectsList[i].getBoundingBox().isPointInBox(hitX,hitY))
                {
                    hitShot += 1;
                    score += objectsList[i].rewardPoints();
                    $("#your-score").text(String(score));
                    objectsList[i].randomize(i);
                }
            }
            $("#accuracy").text(String(Math.round(hitShot/totalShot * 100)) + "%");
        }

        function doFrame(now){
            if (gameStartTime == 0) gameStartTime = now;
            
            currentTime = now;
            //Update the time remaining
            const gameTimeSoFar = now - gameStartTime;
            const timeRemaining = Math.ceil((totalGameTime * 1000 - gameTimeSoFar) /1000);

            $("#time-remaining").text(timeRemaining);
            $("#your-score").text(String(score));

            if(timeRemaining <= 0)
            {
                
                $("#time-remaining").text(0);
                if(score > enemyScore)
                    $("#win-lose").text("win");
                else if(score < enemyScore)
                    $("#win-lost").text("lose");
                else
                    $("$win-lose").text("draw");
                $("#game-over").show();
                setTimeout(() => {location.href = "/Project/public/Game/game_over.html"}, 3000);
                return;
            }

            playerGun.update(now);
            objects[0].update(now);
            objects[1].update(now);
            objects[2].update(now);
            abilitys[0].update(now);
            
            randomization(objects);
            randomization(abilitys);
            const {x, y} = (playerGun.getXY());
            checkCollision(x,y, abilitys, playerGun);
            context.clearRect(0, 0, cv.width, cv.height);

            objects[0].draw();
            objects[1].draw();
            objects[2].draw();
            abilitys[0].draw();
            playerGun.draw();
            requestAnimationFrame(doFrame);
        }



        $(document).on("keydown", function(event) {
            if(event.keyCode == "37"){
                playerGun.move(1);
            }
            else if(event.keyCode == "38"){
                playerGun.move(2);
            }
            else if(event.keyCode == "39"){
                playerGun.move(3);
            }
            else if (event.keyCode == "40"){
                playerGun.move(4);
            }
            else if (event.keyCode == "32"){
                const {x, y} = playerGun.shoot(currentTime);
                checkFireHit(x, y, objects);
            }
            else if (event.keyCode == "88"){
                score += 50;
                gameStartTime -= 50000;
            }
        });

        /* Handle the keyup of arrow keys and spacebar */
        $(document).on("keyup", function(event) {
            if(event.keyCode == "37"){
                playerGun.stop(1);
            }
            else if(event.keyCode == "38"){
                playerGun.stop(2);
            }
            else if(event.keyCode == "39"){
                playerGun.stop(3);
            }
            else if (event.keyCode == "40"){
                playerGun.stop(4);
            }
        });
        gameStartCountDown();
    });
    </script>
</body>
</html>